# coe-dashboard Microservice 
The below documentation explains the maven modules in this coe-dashboard microservice.

## coe-dashboard-ms
This project contains the aggregator POM for every artifact making part of checkout. 
To build all the checkout modules run the below command from coe-dashboard-ms project

> mvn clean install

### Modules

### coe-dashboard-api
This module contains the YAML file with the Swagger definition for the coe-dashboard application. 
It also generate the server-side code, java code for external API's & HTML documentation for 
the services defined in the YAML file.

### coe-dashboard-client-kit
This module contains only the POM file to generate the client kit using the YAML file in
coe-dashboard-api. Note that this module is not used by consumers of the service (which copy the API) but 
may be used when testing the service.

### coe-dashboard-exe
This module builds the executable JAR file for the checkout application.

### coe-dashboard-gateways
This module accesses external services that are used by checkout. In addition to service consumption, it 
includes asynchronous message publishing and subscription.

### coe-dashboard-persistence
This module contains all Couchbase related API's for the checkout application.

### coe-dashboard-resources
This module contains the implementation of the delegate interfaces generated by the Swagger code
generator. This module also contains the mapper interface & implementation to map the resource
layer models to and from the service layer models.

### coe-dashboard-services
This module contains the service (domain) implementation. This also contains the  DTO interfaces
under the *.repository.dto.* package. The implementation of these interfaces can be found in 
coe-dashboard-persistence. The mappers in the coe-dashboard-resources uses these interfaces to map
the resource models to the service models.

### coe-dashboard-tests
This module should contain the unit test for the checkout application. 

## Running the application
The application can be started using the executable JAR in coe-dashboard-exe/target after running the Maven build.

> java -jar coe-dashboard-exe/target/coe-dashboard-exe-1.0.0-SNAPSHOT.jar

In order to run checkout, you also need to run shoppingcart and productorder

> java -jar shoppingcart-exe/target/shoppingcart-exe-1.0.0-SNAPSHOT.jar --server.port=8081
> java -jar productorder-exe/target/productorder-exe-1.0.0-SNAPSHOT.jar --server.port=8082

Note that each application has configuration for Couchbase. You may need to over-ride the default configuration
for your testing. For example, to change the Couchbase configuration for shoppingcart add these options:

> java \
-Dcouchbase.providers[0].env.clusterUrl=127.0.0.1 \
-Dcouchbase.providers[0].env.bucketName=com.amdocs.ms.shoppingcart \
-Dcouchbase.providers[0].name=cbProvider \
-jar shoppingcart-exe/target/shoppingcart-exe-1.0.0-SNAPSHOT.jar --server.port=8081


## Testing the application

### Create ShoppingCart
You must create a ShoppingCart to checkout.

curl -i -X POST http://127.0.0.1:8081/shoppingcart-management/v1/shopping-carts?salesChannel= -H "Content-Type:application/json" -d @- << EOF
{
    "shoppingCartItem":
       [
           {
               "state":"ReadyForCheckout",
               "quantity":"1",
               "productOffering":
                  {
                       "name":"Apple iPhone 7",
                       "id":"IPHONE_7"
                  }
       }
       ]
}
EOF

The "id" returned in the response should be substituted in place of "ShoppingCart_1" in the tests below.

### Create Checkout
Create a Checkout for the ShoppingCart.  

curl -i -X POST http://127.0.0.1:8080/checkout-management/v1/checkouts -H "Content-Type:application/json" -d @- << EOF
{
       "id":"ShoppingCart_1"
}
EOF

The "id" returned in the response should be substituted in place of "Checkout_1" in the tests below.
The "productOrder.id" returned in the response should be substituted in place of "ProductOrder_1" in the tests below.

### Get Checkout
Verify the Checkout.

curl -i -X GET http://127.0.0.1:8080/checkout-management/v1/checkouts/Checkout_1 -H "Content-Type:application/json"

### Get Product Order
Verify the Product Order.

curl -i -X GET http://127.0.0.1:8082/productorder-management/v1/product-orders/ProductOrder_1?salesChannel=channel -H "Content-Type:application/json"

### Update Checkout
Confirm the Checkout by updating the state.

curl -i -X PATCH http://127.0.0.1:8080/checkout-management/v1/checkouts/Checkout_1 -H "Content-Type:application/json" -d @- << EOF
[
  {
    "op": "replace",
    "path": "/state",
    "value": "Confirmed"
  }
]
EOF

## Negative Tests

### POST specifies unknown Shopping Cart

curl -i -X POST http://127.0.0.1:8080/checkout-management/v1/checkouts -H "Content-Type:application/json" -d @- << EOF
{
       "id":"ShoppingCart_XXX"
}
EOF

### GET specifies unknown Checkout

curl -i -X GET http://127.0.0.1:8080/checkout-management/v1/checkouts/Checkout_XXX -H "Content-Type:application/json"


### PUT Specifies unknown Checkout

curl -i -X PUT http://127.0.0.1:8080/checkout-management/v1/checkouts/Checkout_XXX -H "Content-Type:application/json" -d @- << EOF
{
  "href": null,
  "rel": null,
  "id": "Checkout_XXX",
  "state": "Confirmed",
  "validFor": null,
  "relatedParty": [],
  "shoppingCart": {
    "href": null,
    "rel": null,
    "id": "ShoppingCart_1"
  },
  "productOrder": null
}
EOF


### PUT Update body specifies Checkout Id that does not match request parameter
 
curl -i -X PUT http://127.0.0.1:8080/checkout-management/v1/checkouts/Checkout_1 -H "Content-Type:application/json" -d @- << EOF
{
  "href": null,
  "rel": null,
  "id": "Checkout_XXX",
  "state": "Confirmed",
  "validFor": null,
  "relatedParty": [],
  "shoppingCart": {
    "href": null,
    "rel": null,
    "id": "ShoppingCart_1"
  },
  "productOrder": null
}
EOF

### PUT Update specifies bad reference

curl -i -X PUT http://127.0.0.1:8080/checkout-management/v1/checkouts/Checkout_1 -H "Content-Type:application/json" -d @- << EOF
{
  "href": null,
  "rel": null,
  "id": "Checkout_1",
  "state": "Confirmed",
  "validFor": null,
  "relatedParty": [],
  "shoppingCart": {
    "href": null,
    "rel": null,
    "id": "ShoppingCart_XXX"
  },
  "productOrder": null
}
EOF

### PATCH Specifies unknown Checkout

curl -i -X PATCH http://127.0.0.1:8080/checkout-management/v1/checkouts/Checkout_XXX -H "Content-Type:application/json" -d @- << EOF
[
  {
    "op": "replace",
    "path": "/state",
    "value": "Confirmed"
  }
]
EOF
  
### PATCH Specifies bad state 

curl -i -X PATCH http://127.0.0.1:8080/checkout-management/v1/checkouts/Checkout_1 -H "Content-Type:application/json" -d @- << EOF
[
  {
    "op": "replace",
    "path": "/state",
    "value": "XXXX"
  }
]
EOF

### PATCH Specifies non-numeric If-Match

curl -i -X PATCH http://127.0.0.1:8080/checkout-management/v1/checkouts/Checkout_1 -H "If-Match:XXX" -H "Content-Type:application/json" -d @- << EOF
[
  {
    "op": "replace",
    "path": "/state",
    "value": "Confirmed"
  }
]
EOF
